<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Public Ledger</title>
<style>
  :root { --fg:#111; --muted:#666; --bg:#fff; --row:#fafafa; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
       margin:24px; color:var(--fg); background:var(--bg)}
  h1{margin:0 0 6px}
  .meta{color:var(--muted); margin-bottom:16px}
  .toolbar{display:flex; gap:12px; align-items:center; margin-bottom:12px}
  input[type=search]{padding:6px 10px; border:1px solid #ddd; border-radius:8px; min-width:220px}
  button{padding:6px 10px; border:1px solid #ddd; background:#fff; border-radius:8px; cursor:pointer}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{border:1px solid #eee; padding:10px 8px; text-align:left}
  th{background:#f6f6f6}
  tbody tr:nth-child(even){background:var(--row)}
  .right{ text-align:right }
  .badge{padding:2px 6px; border-radius:999px; background:#f2f2f2; font-size:12px}
</style>

<h1>Public Ledger</h1>
<div class="meta">
  Source CSV: <a id="src" target="_blank" rel="noopener">loading…</a>
  &nbsp;•&nbsp; Last updated: <span id="updated">–</span>
</div>

<div class="toolbar">
  <input id="q" type="search" placeholder="Search merchant…" />
  <button id="refresh">Refresh</button>
  <span class="badge" id="stats">0 rows • ¥0.00</span>
</div>

<table id="t">
  <thead><tr><th>time</th><th>merchant</th><th class="right">amount</th></tr></thead>
  <tbody></tbody>
</table>

<script>
const CSV_URL = "https://raw.githubusercontent.com/Lay-Yin/SUSTech-baseball-Softball-Team-Public-ledger/main/public-ledger.csv";

document.getElementById('src').href = CSV_URL;
document.getElementById('src').textContent = CSV_URL;

function parseCSV(text){
  // robust-ish CSV parser for quotes/commas
  const rows = [];
  let row = [], cur = '', inQ = false;
  for (let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if (inQ){
      if (c === '"' && n === '"'){ cur += '"'; i++; }
      else if (c === '"'){ inQ = false; }
      else cur += c;
    } else {
      if (c === '"'){ inQ = true; }
      else if (c === ','){ row.push(cur); cur=''; }
      else if (c === '\n'){ row.push(cur.replace(/\r$/, '')); rows.push(row); row=[]; cur=''; }
      else cur += c;
    }
  }
  if (cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows.filter(r => r.length && r.join('').trim().length);
}

function toDate(s){
  // expect "YYYY-MM-DD HH:mm:ss"
  return new Date(s.replace(' ', 'T'));
}

function render(rows){
  const tbody = document.querySelector('#t tbody');
  const q = document.getElementById('q').value.trim();
  let total = 0;
  tbody.innerHTML = rows.map(r=>{
    const [time, merchant, amountStr] = r;
    if (q && !merchant.includes(q)) return '';
    const amount = Number((amountStr||'').replace(/,/g,''));
    if (!Number.isNaN(amount)) total += amount;
    return `<tr>
      <td>${time}</td>
      <td>${merchant}</td>
      <td class="right">${Number.isNaN(amount) ? '' : amount.toFixed(2)}</td>
    </tr>`;
  }).join('');
  const visible = [...tbody.querySelectorAll('tr')].length;
  document.getElementById('stats').textContent = `${visible} rows • ¥${total.toFixed(2)}`;
}

async function load(){
  const res = await fetch(CSV_URL + "?t=" + Date.now(), { cache: "no-store" });
  const text = await res.text();
  const rows = parseCSV(text);
  // drop header if present
  const data = (rows[0] && rows[0][0].toLowerCase() === 'time') ? rows.slice(1) : rows;
  // sort by time desc (falls back to original if parse fails)
  data.sort((a,b)=> toDate(b[0]) - toDate(a[0]));
  render(data);
  document.getElementById('updated').textContent = new Date().toLocaleString();
}

document.getElementById('refresh').onclick = load;
document.getElementById('q').addEventListener('input', ()=> {
  // re-render using last loaded rows in table
  // quick re-parse from DOM header for simplicity: reload instead if needed
  load();
});

load();
</script>
